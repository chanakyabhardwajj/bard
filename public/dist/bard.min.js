"use strict";var bard=angular.module("bard",["ngCookies","ngResource","ngRoute","ngSanitize","ngAnimate","ui.bootstrap","ui.route","bard.Articles","bard.Authors","bard.UserStatus"]);bard.run(["$rootScope",function($root){$root.$on("$routeChangeStart",function(e,curr){curr.$$route&&curr.$$route.resolve&&($root.loadingView=!0)}),$root.$on("$routeChangeSuccess",function(){$root.loadingView=!1})}]),angular.module("bard.Articles",[]),angular.module("bard.Authors",[]),angular.module("bard.UserStatus",[]),angular.module("bard.Articles").factory("ArticlesService",["$resource",function($resource){return $resource("articles/:articleId",{articleId:"@_id"},{update:{method:"PUT"}})}]).factory("KeyShortcutsService",[function(){return{"mod+0":function(){return document.execCommand("removeFormat"),document.execCommand("formatBlock",!1,"div"),document.execCommand("outdent"),!1},"mod+1":function(){return document.execCommand("formatblock",!1,"h1"),!1},"mod+2":function(){return document.execCommand("formatblock",!1,"h2"),!1},"mod+b":function(){return document.execCommand("bold"),!1},"mod+i":function(){return document.execCommand("italic"),!1},"mod+u":function(){return document.execCommand("underline"),!1},"mod+shift+a":function(){return document.execCommand("justifyleft"),!1},"mod+shift+d":function(){return document.execCommand("justifyright"),!1},"mod+shift+s":function(){return document.execCommand("justifycenter"),!1},tab:function(){return document.execCommand("indent"),!1},"shift+tab":function(){return document.execCommand("outdent"),!1}}}]),angular.module("bard.Authors").factory("AuthorsService",["$resource",function($resource){return $resource("users/:username",{username:"@username"})}]),angular.module("bard.UserStatus").factory("UserStatusService",[function(){var _this=this;return _this._data={user:window.user,authenticated:!!window.user},_this._data}]).factory("BufferappService",["$resource","UserStatusService",function($resource){return $resource("https://api.bufferapp.com/1/profiles.json?callback=JSON_CALLBACK",{access_token:"@token"},{fetch:{method:"JSONP",isArray:!1,callback:"JSON_CALLBACK",transformResponse:function(data){for(var profilesIdArr=[],i=0;i<data.length;i++)profilesIdArr.push(data[i].id);return{profilesIdArr:profilesIdArr}}}})}]),angular.module("bard.Articles").directive("contenteditable",function(){return{restrict:"A",require:"?ngModel",link:function(scope,element,attrs,ngModel){function read(){var html=element.html();(attrs.stripBr&&"<br>"===html||""===angular.element(element).text())&&angular.element(element).html(""),ngModel.$setViewValue(html)}ngModel&&(ngModel.$render=function(){element.html(ngModel.$viewValue||"")},ngModel.$setPristine(),ngModel.$dirty=!1,element.on("blur keyup change",function(){scope.$apply(read)}),read())}}}).directive("keypress",function(){function bindKey(k,scope,element,attributes){window.Mousetrap.bind(k,function(){return attributes[k](scope,element)})}return function(scope,element,attrs){var attributes=scope.$eval(attrs.keypress||"{}");for(var k in attributes)bindKey(k,scope,element,attributes)}}).directive("fbshare",[function(){return{restrict:"A",replace:!1,transclude:!1,scope:{article:"=article"},link:function(scope,elem){elem.bind("click",function(){window.open("https://www.facebook.com/sharer/sharer.php?app_id="+window.fb_app_id+"&description="+scope.article.title+"&u="+encodeURIComponent(window.location.href)+"&display=popup","targetWindow","toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width=500,height=350")})}}}]).directive("tweet",[function(){return{restrict:"A",replace:!1,transclude:!1,scope:{article:"=article"},link:function(scope,elem){elem.bind("click",function(){window.open("https://twitter.com/intent/tweet?text="+encodeURIComponent(scope.article.title)+"&url="+encodeURIComponent(window.location.href),"targetWindow","toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes,width=500,height=350")})}}}]),angular.module("bard.Articles").filter("fromNow",["$window",function($window){return function(date){return $window.moment(date).fromNow()}}]).filter("truncate",function(){return function(value,wordwise,max,tail){if(!value)return"";if(max=parseInt(max,10),!max)return value;if(value.length<=max)return value;if(value=value.substr(0,max),wordwise){var lastspace=value.lastIndexOf(" ");-1!==lastspace&&(value=value.substr(0,lastspace))}return value+(tail||" â€¦")}}).filter("unsafe",function($sce){return function(val){return $sce.trustAsHtml(val)}}),angular.module("bard.UserStatus").directive("typer",function(){return{restrict:"A",link:function(scope,element,attrs){angular.element(element).typer(scope.$eval(attrs.typer))}}}),angular.module("bard.Articles").controller("AllArticlesController",["$scope","$window","$timeout","UserStatusService","ArticlesService","resolvedArticles",function($scope,$window,$timeout,UserStatusService,ArticlesService,resolvedArticles){$scope.userStatus=UserStatusService,$scope.articles=resolvedArticles}]),angular.module("bard.Articles").controller("EditArticleController",["$scope","$route","$routeParams","$location","$timeout","$sanitize","$modal","UserStatusService","ArticlesService","KeyShortcutsService","articlePromise",function($scope,$route,$routeParams,$location,$timeout,$sanitize,$modal,UserStatusService,ArticlesService,KeyShortcutsService,articlePromise){$scope.userStatus=UserStatusService,$scope.shortcuts=KeyShortcutsService,$scope.windowMessage="",$scope.userStatus.authenticated?articlePromise.success?articlePromise.data.user._id===$scope.userStatus.user._id?($scope.article=articlePromise.data,$timeout(function(){$scope.article.content=$scope.article.contentClone},0),$scope.pasted=function($event){$event.target.innerText=$event.target.innerText+$event.originalEvent.clipboardData.getData("text/plain"),$event.originalEvent.preventDefault()},$scope.openModal=function(){$modal.open({templateUrl:"shortcutModal.html"})},$scope.publishToggle=function(){if($scope.article.title&&$scope.article.content){$scope.windowMessage="saving your changes...";var article=$scope.article;article.published=!article.published,article.updated=(new Date).getTime(),article.$update(function(){$route.reload()})}},$scope.update=function(){if($scope.windowMessage="saving your changes...",!$scope.article.title)return $scope.titleError=!0,$scope.windowMessage="you forgot to add the title",void $timeout(function(){$scope.windowMessage=null},3e3);if(!$scope.article.content)return $scope.contentError=!0,$scope.windowMessage="please add some content",void $timeout(function(){$scope.windowMessage=null},3e3);var article=$scope.article;article.updated=(new Date).getTime(),article.$update(function(){$route.reload()})},$scope.remove=function(article){article?article.$remove(function(){for(var i in $scope.articles)$scope.articles[i]===article&&$scope.articles.splice(i,1)}):$scope.article.$remove(function(){$location.path("/")})}):($scope.errored=!0,$scope.errorMsg="You are not authorised to edit this article..."):($scope.errored=!0,$scope.errorMsg=404===articlePromise.data.status?articlePromise.data.data:"Oops! Something went bad..."):($scope.errored=!0,$scope.errorMsg="Please log in to edit this post...")}]),angular.module("bard.Articles").controller("NewArticleController",["$scope","$location","$sanitize","$modal","$timeout","UserStatusService","ArticlesService","KeyShortcutsService",function($scope,$location,$sanitize,$modal,$timeout,UserStatusService,ArticlesService,KeyShortcutsService){$scope.userStatus=UserStatusService,$scope.shortcuts=KeyShortcutsService,$scope.titleError=!1,$scope.contentError=!1,$scope.windowMessage="",$scope.pasted=function($event){$event.target.innerText=$event.target.innerText+$event.originalEvent.clipboardData.getData("text/plain"),$event.originalEvent.preventDefault()},$scope.create=function(toPublish){if($scope.windowMessage=(toPublish?"publishing":"saving")+" your article...",!this.title)return $scope.titleError=!0,$scope.windowMessage="you forgot to add the title",void $timeout(function(){$scope.windowMessage=null},3e3);if(!this.content)return $scope.contentError=!0,$scope.windowMessage="please add some content",void $timeout(function(){$scope.windowMessage=null},3e3);var article=new ArticlesService({title:this.title,subtitle:this.subtitle,content:this.content,published:toPublish});article.$save(function(response){$location.path(toPublish?"/":"articles/"+response._id+"/edit"),$timeout(function(){$scope.windowMessage=null},2e3)})},$scope.openModal=function(){$modal.open({templateUrl:"shortcutModal.html"})}}]),angular.module("bard.Articles").controller("SeeArticleController",["$scope","$http","$routeParams","$location","$window","$timeout","UserStatusService","ArticlesService","articlePromise",function($scope,$http,$routeParams,$location,$window,$timeout,UserStatusService,ArticlesService,articlePromise){$scope.userStatus=UserStatusService,$scope.windowMessage="",articlePromise.success?($scope.article=articlePromise.data,$scope.remove=function(article){article?article.$remove(function(){for(var i in $scope.articles)$scope.articles[i]===article&&$scope.articles.splice(i,1)}):$scope.article.$remove(function(){$location.path("/")})},$scope.userStatus.authenticated&&$scope.userStatus.user&&"bufferapp"===$scope.userStatus.user.provider&&($scope.bufferStatus=null,$scope.share=function(){$scope.windowMessage="sharing through buffer .. hang on",$scope.article.published&&$http.post("/share/"+$scope.article._id).then(function(resp){$scope.bufferStatus="success",$scope.windowMessage=resp.data,$timeout(function(){$scope.windowMessage=null},5e3)},function(err){$scope.bufferStatus="error",$scope.windowMessage=err.data,$timeout(function(){$scope.windowMessage=null},5e3)})})):($scope.errored=!0,$scope.errorMsg=404===articlePromise.data.status?articlePromise.data.data:"Oops! Something went bad...")}]),angular.module("bard.Authors").controller("SeeAuthorController",["$scope","$routeParams","$location","UserStatusService","AuthorsService","authorPromise",function($scope,$routeParams,$location,UserStatusService,AuthorsService,authorPromise){$scope.userStatus=UserStatusService,authorPromise.success?$scope.author={user:authorPromise.data.user,articles:authorPromise.data.articles}:($scope.errored=!0,$scope.errorMsg=404===authorPromise.data.status?authorPromise.data.data:"Oops! Something went bad...")}]),angular.module("bard.UserStatus").controller("UserStatusController",["$scope","$timeout","UserStatusService","BufferappService",function($scope,$timeout,UserStatusService,BufferappService){$scope.userStatus=UserStatusService,$scope.isCollapsed=!1,$scope.userStatus.authenticated&&$scope.userStatus.user&&"bufferapp"===$scope.userStatus.user.provider&&BufferappService.fetch({access_token:$scope.userStatus.user.bufferapp.accessToken},function(data){$scope.userStatus.user.bufferapp.profiles=data.profilesIdArr})}]),angular.module("bard").config(["$routeProvider",function($routeProvider){$routeProvider.when("/articles/create",{templateUrl:"bard/Articles/NewArticle/NewArticleView.html",controller:"NewArticleController"}).when("/articles/:articleId/edit",{templateUrl:"bard/Articles/EditArticle/EditArticleView.html",controller:"EditArticleController",resolve:{articlePromise:function(ArticlesService,$q,$route){var deferred=$q.defer();return ArticlesService.get({articleId:$route.current.params.articleId},function(article){article.contentClone=article.content,deferred.resolve({success:!0,data:article})},function(err){deferred.resolve({success:!1,data:err})}),deferred.promise}}}).when("/articles/:articleId",{templateUrl:"bard/Articles/SeeArticle/SeeArticleView.html",controller:"SeeArticleController",resolve:{articlePromise:function(ArticlesService,$q,$route){var deferred=$q.defer();return ArticlesService.get({articleId:$route.current.params.articleId},function(article){deferred.resolve({success:!0,data:article})},function(err){deferred.resolve({success:!1,data:err})}),deferred.promise}}}).when("/articles",{templateUrl:"bard/Articles/AllArticles/AllArticlesView.html",controller:"AllArticlesController",resolve:{resolvedArticles:function(ArticlesService,$q){var deferred=$q.defer();return ArticlesService.query(function(articles){deferred.resolve(articles)}),deferred.promise}}}).when("/",{templateUrl:"bard/Articles/AllArticles/AllArticlesView.html",controller:"AllArticlesController",resolve:{resolvedArticles:function(ArticlesService,$q){var deferred=$q.defer();return ArticlesService.query(function(articles){deferred.resolve(articles)}),deferred.promise}}}).when("/users/:username",{templateUrl:"bard/Authors/SeeAuthor/SeeAuthorView.html",controller:"SeeAuthorController",resolve:{authorPromise:function(AuthorsService,$q,$route){var deferred=$q.defer();return AuthorsService.get({username:$route.current.params.username},function(author){deferred.resolve({success:!0,data:author})},function(err){deferred.resolve({success:!1,data:err})}),deferred.promise}}}).otherwise({redirectTo:"/"})}]),angular.module("bard").config(["$locationProvider",function($locationProvider){$locationProvider.hashPrefix("!")}]),0===window.location.hash.length?window.location.hash="#!":"/"!==window.location.pathname&&(window.location.path="/",window.location.hash="#!");var loc=window.location.href;-1!==loc.indexOf("#")&&-1===loc.indexOf("#!")&&(window.location.href=loc.replace("#","#!")),angular.element(document).ready(function(){"#_=_"===window.location.hash&&(window.location.hash="#!"),0===window.location.hash.length&&(window.location.hash="#!"),angular.bootstrap(document,["bard"])});